---
tags: [STM32, MCU, 单片机, 嵌入式]
last_modified_time: 2025-03-08 11:56:30 +0800
---

STM32 作为单片机开发的代表之一，其众多理论和方法值得学习，本文是其学习/使用笔记。

## 启动过程
STM32 的启动过程可以简述如下（以 STM32F103C8T6 为例）：
1. 读取 BOOT1 和 BOOT0 引脚的值，决定启动方式：
   * X0: 从内部 Flash 启动，启动地址为 0x800 0000。
   * 01: 从 System Memory 启动地址为 0x1FFF F000。
   * 11：从 SRAM 启动，启动地址为 0x2000 0000。

   详情参见官方 Reference Manual （如 RM0008）的 Boot Configuration 章节（如 3.4 章节）。

2. 将启动地址开始的前 4 字节的值作为栈顶指针，之后 4 字节的值为 Reset_Handler 函数的地址，即复位中断向量，也是中断向量表的起始地址。
3. Reset_Handler 函数中默认会先调用 SystemInit 函数，该函数中可以调整中断向量表的位置，相关代码片段如下：
   ```c
   /* Configure the Vector Table location -------------------------------------*/
   #if defined(USER_VECT_TAB_ADDRESS)
      SCB->VTOR = VECT_TAB_BASE_ADDRESS | VECT_TAB_OFFSET; /* Vector Table Relocation in Internal SRAM. */
   #endif /* USER_VECT_TAB_ADDRESS */
   ```
4. Reset_Handler 在调用完 SystemInit 后会调用 __main 函数，该函数最终调用 main 函数，进入用户代码。

进一步的深入分析可结合 startup_stm32f103xb.s、stm32f1xx.c 等文件。

## 程序下载方式

STM32 的程序主要存储在其内部 Flash 中，Flash 是非易性存储，重新上电后不会清除，类似个人电脑中的硬盘，有时也称之为 ROM（Read Only Memory），ROM 原本指那种一旦写入一次就只能读不可写，但后来也常常用来指代储存执行代码的储存器。与之相反的是 SRAM（Static Random Access Memory），它是易失性存储，重新上电后其数据会被全部清除，类似个人电脑中的内存，与之不同的是，个人电脑中的内存是 DDRAM，即动态内存，而 STM32 中的内存是静态内存，静态内存的读写速率通常高于动态内存。

虽然 STM32 的程序主要储存在其内部 Flash 中，但也可以将其存储在 SRAM 中，从而从 SRAM 中启动而非 FLASH 中启动。

### ICP (In-Circuit Programing)

ICP 即电路内编程，即使用 JTAG/SWD 调试器下载程序，这也是我们最常用的程序下载/更新方式。ICP 方式可以将程序下载到 SRAM 或者 FLASH 中，这可以通过配置 STM32 芯片的 BOOT0、BOOT1 等引脚实现，注意这是针对部分 STM32 芯片的情况，比如 STM32F1 系列，其他芯片并不一定有 BOOT1 引脚，如 STM32H7 系列就没有。

官方将从 System Memory 启动这一启动方式也称之为 ICP，这样官方支持的三种启动方式均统一称之为 ICP，但由于 System Memory 具备一定的特殊性，因为它涉及官方的 Bootloader，该 Bootloader 可以通过多种通信接口下载程序，如 UART、USB、ETH 等，因此我们通常将 System Memory 启动方式单独拿出来，称之为 ISP，这正是接下来需要说明的。

### ISP (In-System Programing)

ISP 即系统内编程，实质对应 STM32 三种启动方式中的 System Memory 启动方式，对于此名称我没有找到比较好的解读，但许多串口工具确实这样称呼这种启动方式，如 sscom、flymcu 等，所以我也将它单独说明。

System Memory 实质是 STM32 内部 Flash 中的一块储存区，不同芯片具有不同的地址和大小，对于 STM32F103C8T6 而言，其地址为 0x1FFF F000，大小为 2KB。这块区域中存储了 ST 官方烧录的 bootloader，该 bootloader 在官方手册 AN2606（STM32 microcontroller system memory boot mode） 中有详细说明，对于从各种通信接口，还有对应的手册作协议上的详细说明，如 AN3155（USART protocol used in the STM32 bootloader）。这两个手册我都通读了下，下面简单总结下。

AN2606 说明了对于各个系列的 STM32 芯片，如何进入该启动模式、bootloader标识、硬件连接要求、串口波特率检测、bootloader models、可使用的硬件资源、通信接口选择流程、bootloader 版本等信息；AN3155 说明了使用 USART 作为通信接口时，其代码执行流程、如何自动选择串口波特率、命令集、协议版本等信息。

ST 官方只提供了使用说明，未提供 bootloader 源码。但其实现了一个 [OpenBL](https://github.com/STMicroelectronics/stm32-mw-openbl)，它是以 IAP 方式下载程序，但支持的通信接口和协议与 System Memory 中内置的 bootloader 完全相同。

事实上，对于 System Memory 中内置的 bootloader，我们没有必要深入其实现细节，许多串口工具均提供了相应的功能，如 sscom 和 flymcu 等，使用起来非常方便。

一个疑问是：在 AN3155 中，明确说明了支持的最大波特率是 115200，但 sscom 等串口工具中的 ISP 下载功能可以以 460800 的波特率下载程序，这是如何实现的？

### IAP (In-Application Programing)

IAP 即应用内编程。此功能意味着可以通过用户程序进行用户程序的升级，即“我升级我自己”，有点类似于在手机 APP 中升级该 APP 本身。该功能的意义是重大的，当产品发布后，程序必须会不断更新迭代，以修复 BUG 和添加新功能，而前述的 ICP 和 ISP 烧录方式此时就行不通了，ICP 需要在产品上提前预留调试接口（JTAG 或 SWD），ISP 需要修改 BOOT0 和 BOOT1 引脚的值（STM32H7等系列例外，它们可以在用户程序中修改启动方式），且用户很难学会相应操作，用户更希望有个简单的上位机即可完成升级，而非自行接线且执行复杂的操作步骤来更新程序。

实现 IAP 的逻辑很简单，在原本的启动地址处（对于 Flash 启动方式而言通常为 0x800 0000）不直接放置用户程序，而是放置用户自定义的 bootloader 程序（注意区别于 ST 官方 System Memory 中内置的 bootloader），然后在该 bootloader 中跳转到用户程序或者执行用户程序更新动作。详情可参考 [基于蓝牙的STM32 IAP在线升级_stm32基于蓝牙模块远程升级-CSDN博客](https://blog.csdn.net/lin5103151/article/details/84960677)

该 bootloader 的实现有两个官方参考：ST 官方的 OpenBL 和 ST 官方例程 [X-CUBE-IAP-USART - STM32Cube in-application programming using the USART embedded software (AN4657) - STMicroelectronics](https://www.st.com/en/embedded-software/x-cube-iap-usart.html#documentation)。我对后者的代码作了较为深入的分析，下面具体说明。

AN4657 中给了一个如何实现用户自定义 bootloader 的例子，该例子实现一个简单的菜单界面，支持 4 个功能：
* 下载/更新用户程序：将用户程序通过 YMODEM 协议下载到内部 Flash 的用户程序区
* 上传用户程序二进制文件：将内部 Flash 的用户程序区上传到用户 PC 上
* 执行更新后的程序：立即运行更新后的程序。
* 配置写保护：对内部 Flash 的用户程序区进行写保护或取消写保护。

在该例子中，进入 bootloader 的条件是上电时一直按住开发板的特定按钮。其核心模块就 3 个：
* flash_if.c: Flash 读写
* ymodem.c: YMODEM 协议的实现
* menu.c: 菜单界面的实现。

该例子代码逻辑清晰、模块化较好，简单调整后即可移植到自己的板子上：对于 STM32F103C8T6 而言，修改 flash_if.h 中的 APPLICATION_ADDRESS、USER_FLASH_END_ADDRESS、USER_FLASH_SIZE、FLASH_PAGE_TO_BE_PROTECTED 即可。

## UART

## Flash

## 应用案例

### 蓝牙模块

### 超声波测距传感器
